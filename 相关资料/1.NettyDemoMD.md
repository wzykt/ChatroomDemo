## netty-demo-server

### NettyServer

ğŸ”¥ â‘  åœ¨ç±»ä¸Šï¼Œæ·»åŠ  `@Component` æ³¨è§£ï¼ŒæŠŠ NettyServer çš„åˆ›å»ºäº¤ç»™ Spring ç®¡ç†ã€‚

- `port` å±æ€§ï¼Œè¯»å– `application.yml é…ç½®æ–‡ä»¶çš„ `netty.port` é…ç½®é¡¹ã€‚
- `#start()` æ–¹æ³•ï¼Œæ·»åŠ  `@PostConstruct` æ³¨è§£ï¼Œå¯åŠ¨ Netty æœåŠ¡å™¨ã€‚
- `#shutdown()` æ–¹æ³•ï¼Œæ·»åŠ  `@PreDestroy` æ³¨è§£ï¼Œå…³é—­ Netty æœåŠ¡å™¨ã€‚

ğŸ”¥ â‘¡ æˆ‘ä»¬æ¥è¯¦ç»†çœ‹çœ‹ `#start()` æ–¹æ³•çš„ä»£ç ï¼Œå¦‚ä½•å®ç° Netty Server çš„å¯åŠ¨ã€‚

`<2.1>` å¤„ï¼Œåˆ›å»º ServerBootstrapç±»ï¼ŒNetty æä¾›çš„**æœåŠ¡å™¨**çš„å¯åŠ¨ç±»ï¼Œæ–¹ä¾¿æˆ‘ä»¬åˆå§‹åŒ– Serverã€‚

`<2.2>` å¤„ï¼Œè®¾ç½® ServerBootstrap çš„å„ç§å±æ€§ã€‚

`<2.2.1>` å¤„ï¼Œè°ƒç”¨ `#group(EventLoopGroup parentGroup, EventLoopGroup childGroup)` æ–¹æ³•ï¼Œè®¾ç½®ä½¿ç”¨ `bossGroup` å’Œ `workerGroup`ã€‚å…¶ä¸­ï¼š

- `bossGroup` å±æ€§ï¼š**Boss** çº¿ç¨‹ç»„ï¼Œç”¨äºæœåŠ¡ç«¯æ¥å—å®¢æˆ·ç«¯çš„**è¿æ¥**ã€‚
- `workerGroup` å±æ€§ï¼š**Worker** çº¿ç¨‹ç»„ï¼Œç”¨äºæœåŠ¡ç«¯æ¥å—å®¢æˆ·ç«¯çš„**æ•°æ®è¯»å†™**ã€‚

> Netty é‡‡ç”¨çš„æ˜¯å¤š Reactor å¤šçº¿ç¨‹çš„æ¨¡å‹ï¼ŒæœåŠ¡ç«¯å¯ä»¥æ¥å—**æ›´å¤š**å®¢æˆ·ç«¯çš„æ•°æ®è¯»å†™çš„èƒ½åŠ›ã€‚åŸå› æ˜¯ï¼š
>
> - åˆ›å»ºä¸“é—¨ç”¨äºæ¥å—**å®¢æˆ·ç«¯è¿æ¥**çš„ `bossGroup` çº¿ç¨‹ç»„ï¼Œé¿å…å› ä¸ºå·²è¿æ¥çš„å®¢æˆ·ç«¯çš„æ•°æ®è¯»å†™é¢‘ç¹ï¼Œå½±å“æ–°çš„å®¢æˆ·ç«¯çš„è¿æ¥ã€‚
> - åˆ›å»ºä¸“é—¨ç”¨äºæ¥æ”¶**å®¢æˆ·ç«¯è¯»å†™**çš„ `workerGroup` çº¿ç¨‹ç»„ï¼Œ**å¤šä¸ª**çº¿ç¨‹è¿›è¡Œå®¢æˆ·ç«¯çš„æ•°æ®è¯»å†™ï¼Œå¯ä»¥æ”¯æŒæ›´å¤šå®¢æˆ·ç«¯ã€‚

`<2.2.2>` å¤„ï¼Œè°ƒç”¨ `#channel(Class<? extends C> channelClass)` æ–¹æ³•ï¼Œè®¾ç½®ä½¿ç”¨ NioServerSocketChannelç±»ï¼Œå®ƒæ˜¯ Netty å®šä¹‰çš„ NIO æœåŠ¡ç«¯ TCP Socket å®ç°ç±»ã€‚

`<2.2.3>` å¤„ï¼Œè°ƒç”¨ `#localAddress(SocketAddress localAddress)` æ–¹æ³•ï¼Œè®¾ç½®æœåŠ¡ç«¯çš„**ç«¯å£**ã€‚

`<2.2.4>` å¤„ï¼Œè°ƒç”¨ `option#(ChannelOption<T> option, T value)` æ–¹æ³•ï¼Œè®¾ç½®æœåŠ¡ç«¯æ¥å—å®¢æˆ·ç«¯çš„**è¿æ¥é˜Ÿåˆ—**å¤§å°ã€‚å› ä¸º TCP å»ºç«‹è¿æ¥æ˜¯ä¸‰æ¬¡æ¡æ‰‹ï¼Œæ‰€ä»¥ç¬¬ä¸€æ¬¡æ¡æ‰‹å®Œæˆåï¼Œä¼šæ·»åŠ åˆ°æœåŠ¡ç«¯çš„è¿æ¥é˜Ÿåˆ—ä¸­ã€‚

`<2.2.5>` å¤„ï¼Œè°ƒç”¨ `#childOption(ChannelOption<T> childOption, T value)` æ–¹æ³•ï¼ŒTCP Keepalive æœºåˆ¶ï¼Œå®ç° TCP å±‚çº§çš„**å¿ƒè·³ä¿æ´»**åŠŸèƒ½ã€‚

`<2.2.6>` å¤„ï¼Œè°ƒç”¨ `#childOption(ChannelOption<T> childOption, T value)` æ–¹æ³•ï¼Œå…è®¸**è¾ƒå°çš„æ•°æ®åŒ…**çš„å‘é€ï¼Œé™ä½å»¶è¿Ÿã€‚

`<2.2.7>` å¤„ï¼Œè°ƒç”¨ `#childHandler(ChannelHandler childHandler)` æ–¹æ³•ï¼Œè®¾ç½®å®¢æˆ·ç«¯è¿æ¥ä¸Šæ¥çš„ Channel çš„å¤„ç†å™¨ä¸º NettyServerHandlerInitializerã€‚

`<2.3>` å¤„ï¼Œè°ƒç”¨ `#bind()` + `#sync()` æ–¹æ³•ï¼Œç»‘å®šç«¯å£ï¼Œå¹¶**åŒæ­¥**ç­‰å¾…æˆåŠŸï¼Œå³å¯åŠ¨æœåŠ¡ç«¯ã€‚

ğŸ”¥ â‘¢ æˆ‘ä»¬æ¥è¯¦ç»†çœ‹çœ‹ `#shutdown()` æ–¹æ³•çš„ä»£ç ï¼Œå¦‚ä½•å®ç° Netty Server çš„å…³é—­ã€‚

`<3.1>` å¤„ï¼Œè°ƒç”¨ Channel çš„ `#close()` æ–¹æ³•ï¼Œå…³é—­ Netty Serverï¼Œè¿™æ ·å®¢æˆ·ç«¯å°±ä¸å†èƒ½è¿æ¥äº†ã€‚

`<3.2>` å¤„ï¼Œè°ƒç”¨ EventLoopGroup çš„ `#shutdownGracefully()` æ–¹æ³•ï¼Œä¼˜é›…å…³é—­ EventLoopGroupã€‚ä¾‹å¦‚è¯´ï¼Œå®ƒä»¬é‡Œé¢çš„çº¿ç¨‹æ± ã€‚





### NettyServerHandlerInitializer 

åœ¨æ¯ä¸€ä¸ªå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯å»ºç«‹å®Œæˆè¿æ¥æ—¶ï¼ŒæœåŠ¡ç«¯ä¼šåˆ›å»ºä¸€ä¸ª Channel ä¸ä¹‹å¯¹åº”ã€‚æ­¤æ—¶ï¼ŒNettyServerHandlerInitializer ä¼šè¿›è¡Œæ‰§è¡Œ `#initChannel(Channel c)` æ–¹æ³•ï¼Œè¿›è¡Œè‡ªå®šä¹‰çš„åˆå§‹åŒ–ã€‚

> å‹æƒ…æç¤ºï¼šåˆ›å»ºçš„å®¢æˆ·ç«¯çš„ Channelï¼Œä¸è¦å’ŒNettyServerçš„ NioServerSocketChannel æ··æ·†ï¼Œä¸æ˜¯åŒä¸€ä¸ªå“ˆã€‚
>
> åœ¨ `#initChannel(Channel ch)` æ–¹æ³•çš„ `ch` å‚æ•°ï¼Œå°±æ˜¯æ­¤æ—¶åˆ›å»ºçš„å®¢æˆ·ç«¯ Channelã€‚

â‘  `<1>` å¤„ï¼Œè°ƒç”¨ Channel çš„ `#pipeline()` æ–¹æ³•ï¼Œè·å¾—å®¢æˆ·ç«¯ Channel å¯¹åº”çš„ChannelPipelineã€‚ChannelPipeline ç”±ä¸€ç³»åˆ—çš„ ChannelHandler ç»„æˆï¼Œåˆæˆ–è€…è¯´æ˜¯ ChannelHandler **é“¾**ã€‚è¿™æ ·ï¼Œ Channel æ‰€æœ‰ä¸Šæ‰€æœ‰çš„äº‹ä»¶éƒ½ä¼šç»è¿‡ ChannelPipelineï¼Œè¢«å…¶ä¸Šçš„ ChannelHandler æ‰€å¤„ç†ã€‚

â‘¡ `<2>` å¤„ï¼Œæ·»åŠ **äº”ä¸ª** ChannelHandler åˆ° ChannelPipeline ä¸­ï¼Œæ¯ä¸€ä¸ªçš„ä½œç”¨çœ‹å…¶ä¸Šçš„æ³¨é‡Šã€‚å…·ä½“çš„ï¼Œæˆ‘ä»¬ä¼šåœ¨åç»­çš„å°èŠ‚è¯¦ç»†è§£é‡Šã€‚



### NettyServerHandler

åˆ›å»º NettyServerHandlerç±»ï¼Œç»§æ‰¿ ChannelInboundHandlerAdapterç±»ï¼Œå®ç°å®¢æˆ·ç«¯ Channel **å»ºç«‹**è¿æ¥ã€**æ–­å¼€**è¿æ¥ã€å¼‚å¸¸æ—¶çš„å¤„ç†ã€‚

â‘  åœ¨ç±»ä¸Šæ·»åŠ  `@ChannelHandler.Sharable `æ³¨è§£ï¼Œæ ‡è®°è¿™ä¸ª ChannelHandler å¯ä»¥è¢«å¤šä¸ª Channel ä½¿ç”¨ã€‚

â‘¡ `channelManager` å±æ€§ï¼Œæ˜¯æˆ‘ä»¬å®ç°çš„å®¢æˆ·ç«¯ Channel çš„ç®¡ç†å™¨ã€‚

- `#channelActive(ChannelHandlerContext ctx)` æ–¹æ³•ï¼Œåœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯**å»ºç«‹**è¿æ¥å®Œæˆæ—¶ï¼Œè°ƒç”¨ NettyChannelManager çš„ `#add(Channel channel)` æ–¹æ³•ï¼Œæ·»åŠ åˆ°**å…¶ä¸­**ã€‚
- `#channelUnregistered(ChannelHandlerContext ctx)` æ–¹æ³•ï¼Œåœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯**æ–­å¼€**è¿æ¥æ—¶ï¼Œè°ƒç”¨ NettyChannelManager çš„ `#add(Channel channel)` æ–¹æ³•ï¼Œä»å…¶ä¸­**ç§»é™¤**ã€‚

â‘¢ `#exceptionCaught(ChannelHandlerContext ctx, Throwable cause)` æ–¹æ³•ï¼Œåœ¨å¤„ç† Channel çš„äº‹ä»¶å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œè°ƒç”¨ Channel çš„ `#close()` æ–¹æ³•ï¼Œ**æ–­å¼€**å’Œå®¢æˆ·ç«¯çš„è¿æ¥ã€‚



## netty-demo-client

### NettyClient

ğŸ”¥ â‘  åœ¨ç±»ä¸Šï¼Œæ·»åŠ  `@Component` æ³¨è§£ï¼ŒæŠŠ NettyClient çš„åˆ›å»ºäº¤ç»™ Spring ç®¡ç†ã€‚

- `serverHost` å’Œ `serverPort` å±æ€§ï¼Œè¯»å– `application.yml`é…ç½®æ–‡ä»¶çš„ `netty.server.host` å’Œ `netty.server.port` é…ç½®é¡¹ã€‚
- `#start()` æ–¹æ³•ï¼Œæ·»åŠ  `@PostConstruct` æ³¨è§£ï¼Œå¯åŠ¨ Netty å®¢æˆ·ç«¯ã€‚
- `#shutdown()` æ–¹æ³•ï¼Œæ·»åŠ  `@PreDestroy` æ³¨è§£ï¼Œå…³é—­ Netty å®¢æˆ·ç«¯ã€‚

ğŸ”¥ â‘¡ æˆ‘ä»¬æ¥è¯¦ç»†çœ‹çœ‹ `#start()` æ–¹æ³•çš„ä»£ç ï¼Œå¦‚ä½•å®ç° Netty Client çš„å¯åŠ¨ï¼Œå»ºç«‹å’ŒæœåŠ¡å™¨çš„è¿æ¥ã€‚

`<2.1>` å¤„ï¼Œåˆ›å»º Bootstrapç±»ï¼ŒNetty æä¾›çš„**å®¢æˆ·ç«¯**çš„å¯åŠ¨ç±»ï¼Œæ–¹ä¾¿æˆ‘ä»¬åˆå§‹åŒ– Clientã€‚

`<2.2>` å¤„ï¼Œè®¾ç½® Bootstrap çš„å„ç§å±æ€§ã€‚

`<2.2.1>` å¤„ï¼Œè°ƒç”¨ `#group(EventLoopGroup group)` æ–¹æ³•ï¼Œè®¾ç½®ä½¿ç”¨ `eventGroup` çº¿ç¨‹ç»„ï¼Œå®ç°å®¢æˆ·ç«¯å¯¹æœåŠ¡ç«¯çš„è¿æ¥ã€æ•°æ®è¯»å†™ã€‚

`<2.2.2>` å¤„ï¼Œè°ƒç”¨ `#channel(Class<? extends C> channelClass)` æ–¹æ³•ï¼Œè®¾ç½®ä½¿ç”¨ NioSocketChannelç±»ï¼Œå®ƒæ˜¯ Netty å®šä¹‰çš„ NIO æœåŠ¡ç«¯ TCP Client å®ç°ç±»ã€‚

`<2.2.3>` å¤„ï¼Œè°ƒç”¨ `#remoteAddress(SocketAddress localAddress)` æ–¹æ³•ï¼Œè®¾ç½®è¿æ¥æœåŠ¡ç«¯çš„**åœ°å€**ã€‚

`<2.2.4>` å¤„ï¼Œè°ƒç”¨ `#option(ChannelOption<T> childOption, T value)` æ–¹æ³•ï¼ŒTCP Keepalive æœºåˆ¶ï¼Œå®ç° TCP å±‚çº§çš„**å¿ƒè·³ä¿æ´»**åŠŸèƒ½ã€‚

`<2.2.5>` å¤„ï¼Œè°ƒç”¨ `#childOption(ChannelOption<T> childOption, T value)` æ–¹æ³•ï¼Œå…è®¸**è¾ƒå°çš„æ•°æ®åŒ…**çš„å‘é€ï¼Œé™ä½å»¶è¿Ÿã€‚

`<2.2.7>` å¤„ï¼Œè°ƒç”¨ `#handler(ChannelHandler childHandler)` æ–¹æ³•ï¼Œè®¾ç½®**è‡ªå·±** Channel çš„å¤„ç†å™¨ä¸º NettyClientHandlerInitializerã€‚ç¨åæˆ‘ä»¬åœ¨2.2.2 NettyClientHandlerInitializerå°èŠ‚æ¥çœ‹çœ‹ã€‚

`<2.3>` å¤„ï¼Œè°ƒç”¨ `#connect()` æ–¹æ³•ï¼Œè¿æ¥æœåŠ¡å™¨ï¼Œå¹¶**å¼‚æ­¥**ç­‰å¾…æˆåŠŸï¼Œå³å¯åŠ¨å®¢æˆ·ç«¯ã€‚åŒæ—¶ï¼Œæ·»åŠ å›è°ƒç›‘å¬å™¨ ChannelFutureListenerï¼Œåœ¨è¿æ¥æœåŠ¡ç«¯å¤±è´¥çš„æ—¶å€™ï¼Œè°ƒç”¨ `#reconnect()` æ–¹æ³•ï¼Œå®ç°å®šæ—¶é‡è¿ã€‚ğŸ˜ˆ å…·ä½“ `#reconnect()` æ–¹æ³•çš„ä»£ç ï¼Œæˆ‘ä»¬ç¨ååœ¨ç…ç…å“ˆã€‚

â‘¢ æˆ‘ä»¬æ¥è¯¦ç»†çœ‹çœ‹ `#shutdown()` æ–¹æ³•çš„ä»£ç ï¼Œå¦‚ä½•å®ç° Netty Client çš„å…³é—­ã€‚

`<3.1>` å¤„ï¼Œè°ƒç”¨ Channel çš„ `#close()` æ–¹æ³•ï¼Œå…³é—­ Netty Clientï¼Œè¿™æ ·å®¢æˆ·ç«¯å°±æ–­å¼€å’ŒæœåŠ¡ç«¯çš„è¿æ¥ã€‚

`<3.2>` å¤„ï¼Œè°ƒç”¨ EventLoopGroup çš„ `#shutdownGracefully()` æ–¹æ³•ï¼Œä¼˜é›…å…³é—­ EventLoopGroupã€‚ä¾‹å¦‚è¯´ï¼Œå®ƒä»¬é‡Œé¢çš„çº¿ç¨‹æ± ã€‚

â‘£ `#send(Invocation invocation)` æ–¹æ³•ï¼Œå®ç°å‘æœåŠ¡ç«¯å‘é€æ¶ˆæ¯ã€‚

å› ä¸º NettyClient æ˜¯å®¢æˆ·ç«¯ï¼Œæ‰€ä»¥æ— éœ€åƒ NettyServer ä¸€æ ·ä½¿ç”¨2.1.4 NettyChannelManagerç»´æŠ¤ Channel çš„é›†åˆã€‚




https://segmentfault.com/a/1190000023231612


![image-20220828170636711](E:\Project\NettyDemo\ç›¸å…³èµ„æ–™\assets\image-20220828170636711.png)
